# Implementation Plan

## 已完成的核心功能

大部分核心功能已經完成實作和測試，包括：

- ✅ 專案結構和基礎配置
- ✅ 資料模型和資料庫層
- ✅ 伺服器服務層（ConfigService, ScanService, MetadataService, AudioService）
- ✅ Fastify API 路由（音檔樹、音檔串流、Metadata API）
- ✅ 前端核心 Hooks（useAudioPlayer, useWaveform, useSpectrogram, useKeyboardNavigation, useAudioMetadata）
- ✅ 前端服務層（AudioBrowserAPI, WaveformGenerator, SpectrogramGenerator）
- ✅ 前端 UI 元件（AudioBrowser, Header, FilterBar, AudioTree, AudioItem, StarRating, WaveformDisplay, SpectrogramDisplay, DescriptionField, AudioPlayer）
- ✅ 前後端整合流程（初始化、播放、Metadata 同步、篩選搜尋）
- ✅ 效能優化和錯誤處理
- ✅ 測試（單元測試、整合測試）
- ✅ 建置配置和啟動腳本
- ✅ 使用者文件

## 待完成的核心功能優化和問題修復

根據最新的需求文件和使用者回報的問題，以下功能需要優化或修復：

- [ ] 21. 背景音檔載入和視覺化生成
  - [x] 21.1 實作背景波形圖生成
    - 修改 WaveformGenerator 使用 Web Workers 或 requestIdleCallback 在背景執行
    - 確保波形圖生成不阻塞主執行緒
    - 實作任務取消機制（當使用者切換音檔時）
    - 更新 useWaveform Hook 支援非同步背景生成
    - _Requirements: 3.1, 3.15, 3.18, 11.5, 11.12_
  
  - [x] 21.2 實作背景頻譜圖生成
    - 修改 SpectrogramGenerator 使用 Web Workers 或 requestIdleCallback 在背景執行
    - 確保頻譜圖生成不阻塞主執行緒
    - 實作任務取消機制（當使用者切換音檔時）
    - 更新 useSpectrogram Hook 支援非同步背景生成
    - _Requirements: 3.1, 3.15, 3.18, 11.6, 11.12_
  
  - [x] 21.3 實作視覺化載入狀態顯示
    - 在 WaveformDisplay 元件中顯示載入指示器或佔位圖
    - 在 SpectrogramDisplay 元件中顯示載入指示器或佔位圖
    - 視覺化生成完成後即時顯示生成的圖形
    - 確保載入狀態不影響使用者操作
    - _Requirements: 3.16, 3.17_
  
  - [x] 21.4 實作音檔載入後立即播放
    - 修改 AudioPlayer 元件允許在視覺化生成前開始播放
    - 確保音檔載入完成後立即可播放
    - 不等待波形圖和頻譜圖生成完成
    - 播放時如果視覺化尚未完成，顯示載入狀態
    - _Requirements: 5.6, 5.7_
  
  - [x] 21.5 優化背景任務管理
    - 實作背景任務佇列管理
    - 確保多個音檔的視覺化生成不互相干擾
    - 實作優先級機制（當前選中音檔優先生成）
    - 提供任務進度追蹤和錯誤處理
    - _Requirements: 11.12, 11.13_
  
  - [x] 21.6 測試背景生成功能
    - 測試波形圖背景生成不阻塞 UI
    - 測試頻譜圖背景生成不阻塞 UI
    - 測試音檔可在視覺化生成前播放
    - 測試視覺化生成完成後即時顯示
    - 測試快速切換音檔時的任務取消機制
    - _Requirements: 3.15, 3.16, 3.18, 5.6, 11.12_

- [x] 1. 資料夾音檔數量計算優化
  - [x] 1.1 更新 ScanService 以遞迴計算資料夾內所有音檔數量
    - 實作 `countTotalAudioFiles` 方法遞迴計算所有子資料夾內的音檔
    - 在 `DirectoryNode` 介面新增 `totalFileCount` 欄位
    - 更新 API 回應以包含 `totalFileCount` 資訊
    - _Requirements: 2.6_
  
  - [x] 1.2 更新前端顯示資料夾音檔數量
    - 修改 AudioTree 元件以顯示遞迴計算的音檔總數
    - 移除 "files" 文字和括弧，僅顯示數字
    - 確保數量計算包含所有子資料夾，不論是否展開
    - _Requirements: 2.5, 2.6_

- [x] 2. 鍵盤導航功能增強
  - [x] 2.1 實作左鍵導航邏輯
    - 選中音檔時：收合該音檔所屬的資料夾並選擇該資料夾
    - 選中已展開的資料夾時：收合該資料夾
    - 選中已收合的資料夾時：收合上層資料夾並選擇上層資料夾
    - _Requirements: 4.4, 4.5, 4.6_
  
  - [x] 2.2 實作右鍵導航邏輯
    - 選中資料夾時：展開該資料夾
    - 選中音檔時：無動作
    - _Requirements: 4.7_
  
  - [x] 2.3 實作數字鍵快速評分
    - 按下 1/2/3 鍵直接設定當前選中音檔的星級評分
    - 更新 useKeyboardNavigation Hook 以處理數字鍵事件
    - _Requirements: 6.6_
  
  - [x] 2.4 實作 Enter 鍵快速編輯描述
    - 按下 Enter 鍵直接進入描述編輯模式
    - 更新 useKeyboardNavigation Hook 以處理 Enter 鍵事件
    - _Requirements: 7.6_
  
  - [x] 2.5 實作從音檔切換到資料夾時停止播放
    - 當選取項目從音檔移動到資料夾時自動停止播放
    - 更新 useKeyboardNavigation Hook 以處理播放狀態
    - _Requirements: 4.11_

- [x] 3. UI 顯示優化
  - [x] 3.1 移除成功載入訊息
    - 確保成功載入時不顯示任何訊息
    - 只在發生錯誤時顯示訊息
    - _Requirements: 2.11_
  
  - [x] 3.2 實作篩選結果總數顯示
    - 在 FilterBar 顯示被篩選出來的總音檔數量
    - 不包含資料夾數量，僅計算音檔
    - _Requirements: 8.7_
  
  - [x] 3.3 實作高亮顯示優化
    - 高亮顯示符合篩選條件的文字
    - 確保高亮不改變文字或字母的寬度（使用背景色而非粗體）
    - _Requirements: 8.5, 8.6_
  
  - [x] 3.4 移除畫面最下方的狀態顯示區塊
    - 移除 Selected/Playing/Progress 顯示區塊
    - 使用高亮背景色表示 Selected 項目
    - 在波形圖和頻譜圖上顯示播放位置標記
    - _Requirements: 10.2_
  
  - [x] 3.5 縮減項目行高以顯示更多內容
    - 減少資料夾和音檔的行高
    - 最大化可見的音檔數量
    - 保持可讀性和可點擊性
    - _Requirements: 2.8, 2.10, 10.3_
  
  - [x] 3.6 修復滑鼠懸停時的閃爍問題
    - 檢查並移除不必要的畫面更新機制
    - 優化 hover 狀態的渲染邏輯
    - 確保流暢的使用者體驗
    - _Requirements: 11.6_

- [x] 4. 播放錯誤處理優化
  - [x] 4.1 實作 AbortError 處理
    - 正確處理快速切換音檔時的 AbortError
    - 不顯示 AbortError 錯誤訊息
    - 清理被中斷的播放資源
    - _Requirements: 12.1, 12.2, 12.4_
  
  - [x] 4.2 確保單一音檔播放
    - 確保同一時間只有一個音檔在播放
    - 切換音檔時正確取消前一個播放請求
    - _Requirements: 12.3_

- [x] 5. 波形圖和頻譜圖顯示
  - [x] 5.1 確認波形圖和頻譜圖正確顯示
    - 檢查 WaveformDisplay 和 SpectrogramDisplay 元件是否正確整合
    - 確保波形圖和頻譜圖在音檔項目中正確顯示
    - 驗證即時生成功能是否正常運作
    - _Requirements: 2.4, 3.1, 3.2, 3.3, 3.4_
  
  - [x] 5.2 在波形圖和頻譜圖上顯示播放進度
    - 實作播放位置標記（進度條或垂直線）
    - 同步更新播放進度顯示
    - 確保進度標記清晰可見
    - _Requirements: 3.4, 5.2_

- [x.] 6. 星級評分和描述功能
  - [x] 6.1 確認星級評分元件正確顯示和互動
    - 檢查 StarRating 元件是否正確整合在音檔項目中
    - 驗證點擊星星可以更新評分
    - 確保評分立即儲存到後端
    - _Requirements: 6.1, 6.2, 6.4, 6.5_
  
  - [x] 6.2 確認描述欄位正確顯示和編輯
    - 檢查 DescriptionField 元件是否正確整合在音檔項目中
    - 驗證點擊描述可以進入編輯模式
    - 確認 Esc 取消、Enter 或失焦儲存的功能
    - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 7. UI 項目高度和選取背景條修復
  - [x] 7.1 修復選取背景條高度問題
    - 確保選取項目的背景條高度與項目本身高度完全一致
    - 避免背景條蓋到上下項目內容
    - 檢查 CSS 樣式設定，確保 padding、margin、line-height 正確
    - _Requirements: 4.11_

- [x] 8. 資料夾點擊行為修復
  - [x] 8.1 實作點擊資料夾任何位置展開收合
    - 修改資料夾項目的點擊事件處理
    - 確保點擊資料夾選取背景條的任何位置都會展開或收合該資料夾
    - 不限於箭頭圖示
    - _Requirements: 4.9_

- [x] 9. 星級和描述互動限制
  - [x] 9.1 限制只有選取的音檔項目才能設定星級或編輯描述
    - 修改 StarRating 元件：只有當前選取的音檔才能點擊星星設定評分
    - 修改 DescriptionField 元件：只有當前選取的音檔才能點擊進入編輯模式
    - 點擊非選取音檔項目的星級或描述欄位時，只選取該項目並開始播放
    - _Requirements: 6.3, 7.3_

- [x] 10. 波形圖顯示修復
  - [x] 10.1 確認波形圖正確顯示
    - 檢查 WaveformDisplay 元件是否正確渲染
    - 確認波形圖在音檔項目中可見
    - 驗證波形圖生成邏輯是否正常運作
    - _Requirements: 3.1, 3.2, 3.3_

- [x] 11. 頻譜圖顯示修復
  - [x] 11.1 修復頻譜圖顯示異常問題
    - 檢查頻譜圖生成邏輯，確保完整顯示音檔內容
    - 實作固定寬度和固定高度的頻譜圖顯示
    - 將完整音檔內容縮放至固定顯示尺寸，不論音檔長度
    - 確保頻譜圖不是只顯示部分圖片內容
    - _Requirements: 3.6, 3.7_

- [x] 12. 波形圖和頻譜圖閃爍問題修復
  - [x] 12.1 修復播放時的圖片閃爍問題
    - 檢查並修復播放時波形圖和頻譜圖閃爍的問題
    - 確保只更新播放進度指示線，不重新生成整個圖形
    - 避免全部顯示的音檔項目圖片都閃爍
    - 使用 React.memo 和 useMemo 優化渲染
    - _Requirements: 3.9, 11.8, 11.9_
  
  - [x] 12.2 確保停止播放或移到資料夾時不閃爍
    - 驗證按空白鍵停止播放後圖片不再閃爍
    - 驗證移到資料夾項目後圖片不再閃爍
    - _Requirements: 3.9, 11.8_

- [x] 13. 播放進度指示線顯示
  - [x] 13.1 在波形圖上顯示播放進度指示線
    - 實作垂直線標記當前播放位置
    - 確保指示線清晰可見
    - 只更新指示線位置，不重新渲染整個波形圖
    - _Requirements: 3.4, 3.9_
  
  - [x] 13.2 在頻譜圖上顯示播放進度指示線
    - 實作垂直線標記當前播放位置
    - 與波形圖同步顯示
    - 只更新指示線位置，不重新渲染整個頻譜圖
    - _Requirements: 3.4, 3.9_

- [x] 14. 描述欄位輸入焦點問題修復
  - [x] 14.1 修復描述欄位失去焦點問題
    - 確保點入描述欄位取得輸入焦點後不會因閃爍而失去焦點
    - 優化渲染邏輯，避免不必要的元件重新渲染
    - 使用 React ref 和 useEffect 確保焦點穩定
    - _Requirements: 7.8, 11.10_
  
  - [x] 14.2 實作描述編輯時停用特殊按鍵功能
    - 在描述欄位輸入時，停用空白鍵的播放控制功能
    - 在描述欄位輸入時，停用方向鍵的導航功能
    - 在描述欄位輸入時，停用左鍵的收合資料夾功能
    - 確保所有按鍵在描述欄位內有正常的輸入效果
    - 更新 useKeyboardNavigation Hook 以追蹤編輯狀態
    - _Requirements: 4.13, 4.14, 4.15_

- [x] 15. Metadata 儲存和顯示修復
  - [x] 15.1 確認星級和描述儲存後正確顯示
    - 驗證點星級和輸入描述後按 Enter 確實儲存
    - 確保儲存後的資料立即在 UI 上顯示
    - 修復因閃爍導致儲存資料消失的問題
    - _Requirements: 6.5, 6.9, 7.5_
  
  - [x] 15.2 實作 Metadata 初始載入和記憶體快取
    - 確保網頁開啟時立刻載入所有星級和描述資料
    - 更新星級或描述時，在瀏覽器記憶體中更新資料
    - 同步傳送更新到後端儲存，但不重新從後端取得
    - 避免反覆從後端取得更新值
    - _Requirements: 6.8, 6.9, 6.10_

- [x] 16. 篩選功能修復
  - [x] 16.1 實作從所有項目中篩選
    - 修改篩選邏輯，從所有項目（包括收合和展開的）中篩選
    - 不限於目前顯示的項目
    - 自動展開符合篩選條件的音檔所在的所有上層資料夾
    - _Requirements: 8.2, 8.5, 9.2, 9.4_

- [x] 17. 頻譜圖頻率範圍修復
  - [x] 17.1 修正頻譜圖顯示 20Hz-20KHz 完整頻率範圍
    - 檢查 SpectrogramGenerator 的 FFT 分析邏輯
    - 確保頻譜圖的最底點對應 20Hz，最高點對應 20KHz
    - 修正頻率 bin 的計算方式，確保完整顯示整個頻率範圍
    - 在可顯示高度內完整顯示，不截斷或遺漏任何頻率區段
    - 驗證頻譜圖的 Y 軸映射是否正確（低頻在底部，高頻在頂部）
    - _Requirements: 3.10, 3.11, 3.12_

- [x] 18. 播放進度指示線顯示修復
  - [x] 18.1 確保播放進度指示線正確顯示在波形圖上
    - 檢查 WaveformDisplay 元件的進度指示線繪製邏輯
    - 確保進度指示線是獨立的細直條，清晰可見
    - 驗證進度指示線位置計算是否準確
    - 確保只有在播放時才顯示進度指示線
    - _Requirements: 3.4, 3.13, 3.14_
  
  - [x] 18.2 確保播放進度指示線正確顯示在頻譜圖上
    - 檢查 SpectrogramDisplay 元件的進度指示線繪製邏輯
    - 確保進度指示線是獨立的細直條，與波形圖同步
    - 驗證進度指示線位置計算是否準確
    - 確保只有在播放時才顯示進度指示線
    - _Requirements: 3.4, 3.13, 3.14_

- [x] 19. 波形圖和頻譜圖閃爍問題最終修復
  - [x] 19.1 徹底解決播放時的閃爍問題
    - 檢查 WaveformDisplay 和 SpectrogramDisplay 的 memo 比較函式
    - 確保只有 progress 變化時才重繪進度 canvas，不重繪主 canvas
    - 驗證父元件傳入的 props 是否穩定（使用 useMemo/useCallback）
    - 檢查 AudioItem 元件是否正確使用 React.memo
    - 確保播放時只有進度指示線移動，波形圖和頻譜圖本身不變化
    - _Requirements: 3.8, 3.9, 11.8, 11.9_
  
  - [x] 19.2 驗證停止播放時不閃爍
    - 測試按空白鍵停止播放後，波形圖和頻譜圖不再閃爍
    - 測試移動到資料夾項目後，波形圖和頻譜圖不再閃爍
    - 確保 progress 為 0 時，進度 canvas 正確清空
    - _Requirements: 3.9, 11.8_

- [x] 20. 篩選功能邏輯修復
  - [x] 20.1 修復篩選邏輯無法正確符合的問題
    - 檢查 AudioBrowser 元件的 itemMatchesFilter 函式
    - 確保篩選邏輯使用不區分大小寫的子字串比對
    - 驗證篩選能正確符合單字的首字母
    - 驗證篩選能正確符合單字中間的字母
    - 驗證篩選能正確符合連續輸入的多個字母
    - 測試對所有階層的資料夾和音檔都能正常運作
    - _Requirements: 8.10, 8.11, 8.12, 8.13, 8.14_
  
  - [x] 20.2 驗證篩選功能對深層資料夾的支援
    - 測試篩選深層子資料夾中的音檔
    - 確保符合條件的音檔能正確展開所有上層資料夾
    - 驗證資料夾名稱篩選能正確顯示該資料夾下所有內容
    - 測試組合篩選（文字 + 星級）的正確性
    - _Requirements: 8.2, 8.4, 8.5, 8.14_

## 未來擴展功能（Phase 1-5）

以下是設計文件中規劃的未來擴展功能，目前尚未實作：

- [ ] 12. Phase 1: 智慧預載與自動生成
  - [ ] 12.1 實作智慧預載機制
    - 當前選取音檔下載完畢後自動播放並同步生成波形圖和頻譜圖
    - 自動預載下一個音檔
    - 持續下載直到螢幕可見範圍內的所有音檔都已下載並生成視覺化
    - _Requirements: 1.3, 1.5, 1.10_

- [ ] 13. Phase 2: 壓縮檔支援
  - [ ] 13.1 實作壓縮檔偵測和解壓縮
    - 偵測特定副檔名的壓縮檔（如 .zip）
    - 自動解壓縮並掃描內部音檔
    - 解壓內容快取到專案子資料夾
    - _Requirements: 1.1, 1.2_
  
  - [ ] 13.2 實作壓縮檔虛擬資料夾顯示
    - 壓縮檔顯示為虛擬資料夾，可展開瀏覽內部音檔
    - 支援壓縮檔內音檔的播放、評分和描述功能
    - _Requirements: 1.2, 1.5, 1.6, 1.7_

- [ ] 14. Phase 3: 附加音檔功能
  - [ ] 14.1 實作附加音檔儲存機制
    - 每個音檔可附加額外的音檔版本
    - 附加音檔儲存於專案子資料夾
    - _Requirements: 1.5_
  
  - [ ] 14.2 實作附加音檔播放控制
    - 顯示附加音檔播放圖示
    - 使用 → 鍵切換到附加音檔播放
    - 使用 ← 鍵切換回原始音檔播放
    - 空白鍵控制播放/停止，重新播放從頭開始
    - 附加音檔不生成波形圖和頻譜圖
    - 播放附加音檔時在圖示上顯示播放狀態
    - _Requirements: 1.4, 1.5_

- [ ] 15. Phase 4: Electron 桌面應用
  - [ ] 15.1 配置 Electron 建置環境
    - 安裝 electron 和 electron-builder
    - 配置 Electron main process（使用現有 server 程式碼）
    - 配置 Electron renderer process（使用現有 client 程式碼）
    - _Requirements: 所有需求_
  
  - [ ] 15.2 實作 Electron 特定功能
    - 原生檔案系統存取
    - 系統托盤整合
    - 自動更新機制
    - 打包為 Windows、Linux、macOS 應用程式
    - _Requirements: 所有需求_

- [ ] 16. Phase 5: 進階功能
  - [ ] 16.1 實作播放清單管理
    - 建立、編輯、刪除播放清單
    - 將音檔加入播放清單
    - 播放清單順序播放
    - _Requirements: 1.5_
  
  - [ ] 16.2 實作音檔標籤系統
    - 為音檔添加自訂標籤
    - 依標籤篩選音檔
    - 標籤管理介面
    - _Requirements: 1.8, 1.9_
  
  - [ ] 16.3 實作匯出/匯入 metadata
    - 匯出 metadata 為 JSON 或 CSV
    - 從檔案匯入 metadata
    - 備份和還原功能
    - _Requirements: 1.6, 1.7_
  
  - [ ] 16.4 實作音檔分析和統計
    - 顯示音檔統計資訊（總數、評分分布等）
    - 音檔時長分析
    - 格式分布統計
    - _Requirements: 1.1, 1.2_
  
  - [ ] 16.5 實作批次操作功能
    - 批次更新評分
    - 批次更新描述
    - 批次刪除 metadata
    - _Requirements: 1.6, 1.7_

## 注意事項

- 核心功能（任務 1-11）已全部完成，系統可正常運作
- 未來擴展功能（任務 12-16）為可選功能，可根據需求逐步實作
- 所有新功能應遵循 TDD 開發流程：先寫測試，再寫實作
- 每個新功能都應更新相關文件和測試
